<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart A4 OMR System</title>
    <style>
        /* --- GLOBAL STYLES --- */
        :root { --primary: #2c3e50; --accent: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f4f7f6; }
        
        /* Layout for Screen (Phone/PC) */
        .app-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        /* --- TABS --- */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: #ddd; cursor: pointer; font-weight: bold; border-radius: 8px; font-size: 16px; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* --- FORMS --- */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* --- OMR SHEET PREVIEW (What you see on screen) --- */
        .omr-sheet-container {
            background: white;
            width: 100%;
            /* Aspect ratio of A4 is ~1.414 */
            aspect-ratio: 210/297; 
            position: relative;
            border: 1px solid #999;
            padding: 40px; /* Padding for the preview */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* --- ANCHORS (Crucial for Scanner) --- */
        .anchor { width: 25px; height: 25px; background: black; position: absolute; z-index: 10; }
        .tl { top: 20px; left: 20px; }
        .tr { top: 20px; right: 20px; }
        .bl { bottom: 20px; left: 20px; }
        .br { bottom: 20px; right: 20px; }

        /* --- HEADER --- */
        .omr-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .student-details { display: flex; justify-content: space-between; margin-top: 20px; border: 1px solid #000; padding: 10px; }
        
        /* --- QUESTION GRID --- */
        .q-grid { 
            display: grid; 
            /* Two columns for questions to save space */
            grid-template-columns: 1fr 1fr; 
            column-gap: 40px; 
            row-gap: 5px;
            align-content: start;
            flex-grow: 1;
        }
        .q-row { display: flex; align-items: center; gap: 10px; padding: 5px 0; border-bottom: 1px dashed #eee; }
        
        /* Bubbles */
        .bubble { 
            width: 28px; height: 28px; border-radius: 50%; border: 1px solid #333; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 14px; font-weight: bold; cursor: pointer; user-select: none;
        }
        
        /* Active State (When Teacher Selects Key) */
        .bubble.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- BUTTONS --- */
        .action-btn { background: var(--accent); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin-top: 20px; }
        .print-btn { background: #27ae60; margin-bottom: 15px; }


        /* --- PRINT SETTINGS (STRICT A4) --- */
        @media print {
            @page { size: A4 portrait; margin: 0; }
            body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; }
            
            /* Hide UI Elements */
            .app-container > .tabs, 
            .app-container > #setup-panel > .card:not(#sheet-card), 
            .action-btn, 
            h3, p { 
                display: none !important; 
            }
            
            /* Reset Container for Print */
            .app-container { max-width: none; margin: 0; padding: 0; }
            .card { box-shadow: none; border: none; padding: 0; margin: 0; }
            
            /* Force the Sheet to fill the page */
            .omr-sheet-container {
                width: 210mm;
                height: 297mm;
                border: none;
                padding: 15mm; /* Safe print margin */
                position: absolute;
                top: 0;
                left: 0;
            }
            
            /* Hide the "Selected" color on print (Student sheet should be empty) */
            .bubble.selected { background: transparent !important; color: black !important; border: 1px solid #333 !important; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('setup')">1. Setup & Key</button>
        <button class="tab-btn" onclick="switchTab('scan')">2. Scan Sheet</button>
    </div>

    <div id="setup-panel">
        
        <div class="card">
            <h3>üìù Exam Config</h3>
            <label>School Name</label>
            <input type="text" id="schoolName" placeholder="e.g. Saraswati Shishu Mandir" oninput="updateSheet()">
            
            <div class="grid-options">
                <div>
                    <label>Exam Name</label>
                    <input type="text" id="examName" placeholder="e.g. Half Yearly" oninput="updateSheet()">
                </div>
                <div>
                    <label>Total Questions</label>
                    <input type="number" id="qCount" value="20" min="5" max="60" onchange="renderSheet()">
                </div>
            </div>
        </div>

        <div class="card" id="sheet-card">
            <h3 class="no-print">üîë Set Answer Key (Tap Bubbles)</h3>
            <p class="no-print" style="color:#666; font-size:0.9em; margin-bottom:15px;">
                Tap the correct bubbles below. They will turn BLUE on screen (to save the key) but will print EMPTY for students.
            </p>

            <div class="omr-sheet-container" id="printableArea">
                
                <div class="anchor tl"></div>
                <div class="anchor tr"></div>
                <div class="anchor bl"></div>
                <div class="anchor br"></div>

                <div class="omr-header">
                    <h1 id="dispSchool" style="margin:0; font-size: 24px;">SCHOOL NAME</h1>
                    <h3 id="dispExam" style="margin:5px 0; font-weight:normal;">EXAM NAME</h3>
                    
                    <div class="student-details">
                        <span>Name: _______________________________</span>
                        <span>Roll No: ____________</span>
                        <span>Date: ____________</span>
                    </div>
                </div>

                <div id="questionsContainer" class="q-grid"></div>
                
                <div style="margin-top: auto; text-align: center; font-size: 12px; color: #555;">
                    Please fill the circles completely with Blue/Black ballpoint pen. Do not fold this sheet.
                </div>
            </div>

            <button class="action-btn print-btn" onclick="window.print()">üñ®Ô∏è Print Student Sheet (A4)</button>
            <button class="action-btn" onclick="saveKeyAndSwitch()">üíæ Save Key & Open Scanner</button>
        </div>
    </div>

    <div id="scan-panel" class="hidden">
        <div class="card">
            <h3>üì∏ Scanner</h3>
            <div id="keyInfo" style="padding:10px; background:#e8f5e9; border:1px solid #4caf50; border-radius:5px; margin-bottom:15px; color:#2e7d32;">
                Checking config...
            </div>
            
            <p><strong>Note:</strong> Scanner functionality is waiting for the next integration step.</p>
            <button class="action-btn" onclick="switchTab('setup')">‚¨ÖÔ∏è Back to Setup</button>
        </div>
    </div>

</div>

<script>
    // 1. Initialize
    window.onload = function() {
        renderSheet();
        loadSavedConfig();
    };

    // 2. Update Header Text Live
    function updateSheet() {
        document.getElementById('dispSchool').innerText = document.getElementById('schoolName').value || "SCHOOL NAME";
        document.getElementById('dispExam').innerText = document.getElementById('examName').value || "EXAM NAME";
    }

    // 3. Render Bubbles
    function renderSheet() {
        const count = parseInt(document.getElementById('qCount').value);
        const container = document.getElementById('questionsContainer');
        container.innerHTML = ''; 

        // Update header text in case it was empty
        updateSheet();

        for (let i = 1; i <= count; i++) {
            const row = document.createElement('div');
            row.className = 'q-row';
            
            // Q Number
            const qNum = document.createElement('span');
            qNum.innerText = (i < 10 ? "0" + i : i) + ".";
            qNum.style.width = "30px";
            qNum.style.fontWeight = "bold";
            row.appendChild(qNum);

            // Options
            ['A', 'B', 'C', 'D'].forEach(opt => {
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.innerText = opt;
                bubble.onclick = () => toggleSelection(i, opt, bubble);
                row.appendChild(bubble);
            });
            container.appendChild(row);
        }
    }

    // 4. Handle Answer Key Selection
    let answerKey = {};

    function toggleSelection(qIdx, opt, bubbleElem) {
        // Clear sibling selection
        const siblings = bubbleElem.parentNode.querySelectorAll('.bubble');
        siblings.forEach(b => b.classList.remove('selected'));

        // Select new
        bubbleElem.classList.add('selected');
        answerKey[qIdx] = opt;
        console.log("Updated Key:", answerKey);
    }

    // 5. Save & Switch
    function saveKeyAndSwitch() {
        const config = {
            school: document.getElementById('schoolName').value,
            exam: document.getElementById('examName').value,
            totalQ: document.getElementById('qCount').value,
            key: answerKey
        };
        localStorage.setItem('omrConfig', JSON.stringify(config));
        switchTab('scan');
    }

    function switchTab(tab) {
        document.getElementById('setup-panel').classList.add('hidden');
        document.getElementById('scan-panel').classList.add('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

        if(tab === 'setup') {
            document.getElementById('setup-panel').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
        } else {
            document.getElementById('scan-panel').classList.remove('hidden');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            loadSavedConfig();
        }
    }

    function loadSavedConfig() {
        const data = localStorage.getItem('omrConfig');
        if(data) {
            const c = JSON.parse(data);
            const keyLen = Object.keys(c.key).length;
            document.getElementById('keyInfo').innerHTML = `
                ‚úÖ <strong>Exam Loaded:</strong> ${c.exam}<br>
                üìö <strong>Questions:</strong> ${c.totalQ}<br>
                üîë <strong>Answer Key Set:</strong> ${keyLen} / ${c.totalQ} answers
            `;
        } else {
            document.getElementById('keyInfo').innerHTML = `‚ö†Ô∏è No Answer Key found. Please go to Setup tab.`;
            document.getElementById('keyInfo').style.background = "#ffebee";
            document.getElementById('keyInfo').style.borderColor = "#c62828";
            document.getElementById('keyInfo').style.color = "#c62828";
        }
    }
</script>

</body>
</html>
